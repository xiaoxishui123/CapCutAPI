# 剪映草稿识别问题解决方案

## 问题描述

用户在使用剪映草稿助手时遇到以下问题：
1. 通过draft_url下载的剪映草稿文件无法被剪映识别
2. 剪映显示"草稿不存在于缓存中"的错误
3. 即使草稿文件夹被识别，剪映也无法显示其中的内容

## 问题分析

### 1. 下载URL被拦截问题
- **现象**: 访问下载URL返回HTML页面而不是直接下载文件
- **原因**: 域名`www.install-ai-guider.top`指向Cloudflare/Vercel服务，而不是我们的Flask服务器
- **影响**: 用户无法直接下载草稿文件

### 2. 草稿文件结构不完整
- **现象**: 草稿文件夹被识别但内容为空
- **原因**: 缺少关键文件`draft_content.json`
- **影响**: 剪映无法识别项目内容

### 3. 平台信息不匹配
- **现象**: 草稿文件中的平台信息为Mac系统
- **原因**: 模板文件中的平台信息硬编码为Mac系统
- **影响**: 在Windows系统上可能无法正确识别

### 4. 草稿内容为空
- **现象**: 剪映显示"素材拖拽到这里,开始你的大作吧~"
- **原因**: 草稿文件虽然结构正确，但没有任何实际内容
- **影响**: 用户看到空项目

## 解决方案

### 1. 修复下载URL问题

**问题**: 域名指向Cloudflare，无法直接访问Flask服务器

**解决方案**: 使用服务器IP地址替代域名

```python
# 修改前
draft_url = f"https://www.install-ai-guider.top/draft/downloader?draft_id={draft_id}"

# 修改后
server_ip = "8.148.70.18"
draft_url = f"http://{server_ip}:9000/draft/downloader?draft_id={draft_id}"
```

**修改文件**:
- `capcut_server.py` - 修改`generate_draft_url`函数
- `create_simple_draft_fixed.py` - 修改URL生成逻辑

### 2. 添加缺失的关键文件

**问题**: 缺少`draft_content.json`文件

**解决方案**: 在草稿创建脚本中添加该文件

```python
# 特殊处理draft_content.json，更新平台信息为Windows系统
content_src = "template_jianying/draft_content.json"
if os.path.exists(content_src):
    with open(content_src, 'r', encoding='utf-8') as f:
        content_info = json.load(f)
    
    # 更新平台信息为Windows系统
    content_info["platform"]["os"] = "windows"
    content_info["platform"]["os_version"] = "10.0.19045"
    # ... 其他平台信息更新
    
    with open(f"{draft_dir}/draft_content.json", "w", encoding="utf-8") as f:
        json.dump(content_info, f, ensure_ascii=False, indent=4)
```

### 3. 修复平台信息

**问题**: 所有文件中的平台信息都是Mac系统

**解决方案**: 动态更新所有文件中的平台信息

```python
# 更新draft_meta_info.json中的路径
meta_info["draft_root_path"] = "C:\\Users\\Administrator\\AppData\\Local\\JianyingPro\\User Data\\Projects\\com.lveditor.draft"
meta_info["draft_fold_path"] = "C:\\Users\\Administrator\\AppData\\Local\\JianyingPro\\User Data\\Projects\\com.lveditor.draft\\草稿"

# 更新draft_content.json中的平台信息
content_info["platform"]["os"] = "windows"
content_info["platform"]["os_version"] = "10.0.19045"
```

### 4. 创建包含实际内容的草稿

**问题**: 草稿文件为空，没有实际内容

**解决方案**: 创建包含示例内容的草稿文件

```python
# 添加示例文本内容
"texts": [
    {
        "id": "TEXT_001",
        "name": "示例文本",
        "content": "欢迎使用剪映！",
        "font_size": 48,
        "color": "#FFFFFF",
        "start_time": 0,
        "end_time": 5.0,
        "duration": 5.0
    }
]

# 添加文本轨道
"tracks": [
    {
        "id": str(uuid.uuid4()).upper(),
        "name": "文本轨道",
        "type": "text",
        "visible": True,
        "segments": [
            {
                "material_id": "TEXT_001",
                "start_time": 0,
                "end_time": 5.0,
                "duration": 5.0
            }
        ]
    }
]
```

## 修复后的文件结构

```
草稿文件夹/
├── draft_info.json          # 基础草稿信息
├── draft_content.json       # 项目内容信息（关键文件）
├── draft_meta_info.json     # 元数据信息
├── attachment_pc_common.json
├── draft_agency_config.json
├── draft_biz_config.json
├── draft_cover.jpg
├── draft_settings
├── attachment_editing.json
├── performance_opt_info.json
└── common_attachment/       # 附件目录
    ├── aigc_aigc_generate.json
    └── attachment_script_video.json
```

## 验证方法

### 1. 检查草稿文件内容
```bash
# 检查文件结构
unzip -l ./tmp/zip/dfd_cat_1752820473_6adc4bb3.zip

# 检查平台信息
unzip -p ./tmp/zip/dfd_cat_1752820473_6adc4bb3.zip draft_content.json | python3.9 -c "import json, sys; data=json.load(sys.stdin); print(f'OS: {data[\"platform\"][\"os\"]}'); print(f'App Source: {data[\"platform\"][\"app_source\"]}')"

# 检查内容
unzip -p ./tmp/zip/dfd_cat_1752820473_6adc4bb3.zip draft_content.json | python3.9 -c "import json, sys; data=json.load(sys.stdin); print(f'轨道数量: {len(data.get(\"tracks\", []))}'); print(f'文本数量: {len(data.get(\"materials\", {}).get(\"texts\", []))}')"
```

### 2. 测试下载功能
```bash
# 测试下载URL
curl -I "http://8.148.70.18:9000/draft/downloader?draft_id=dfd_cat_1752820473_6adc4bb3"

# 下载文件
curl "http://8.148.70.18:9000/draft/downloader?draft_id=dfd_cat_1752820473_6adc4bb3" -o test_draft.zip
```

## 最终结果

✅ **问题完全解决**:
- 剪映能够正确识别草稿文件夹
- 剪映能够显示草稿内容（文本"使用剪映"）
- 剪映能够显示正确的草稿参数
- 时间线上显示文本轨道

## 相关文件

### 修复的脚本文件
- `create_simple_draft_fixed.py` - 修复后的简单草稿创建脚本
- `create_sample_draft.py` - 包含示例内容的草稿创建脚本
- `capcut_server.py` - 修复下载URL生成逻辑

### 测试草稿
- **草稿ID**: `dfd_cat_1752820473_6adc4bb3`
- **下载URL**: `http://8.148.70.18:9000/draft/downloader?draft_id=dfd_cat_1752820473_6adc4bb3`
- **内容**: 包含"使用剪映"文本，5秒时长

## 预防措施

1. **定期检查模板文件**: 确保模板文件中的平台信息正确
2. **测试下载功能**: 定期测试下载URL是否正常工作
3. **验证草稿内容**: 确保生成的草稿包含必要的文件结构
4. **监控服务器状态**: 确保Flask服务器正常运行

## 总结

通过系统性的问题分析和逐步修复，我们成功解决了剪映草稿识别的问题。关键是要确保：
1. 下载URL能够直接访问到Flask服务器
2. 草稿文件包含所有必要的文件
3. 平台信息与实际使用环境匹配
4. 草稿文件包含实际内容而不是空项目

这个解决方案为后续创建更复杂的草稿文件提供了可靠的基础。