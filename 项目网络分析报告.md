# CapCutAPI é¡¹ç›®ç½‘ç»œåˆ†ææŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

CapCutAPIæ˜¯ä¸€ä¸ªåŸºäºPython Flaskçš„å‰ªæ˜ /CapCutè‡ªåŠ¨åŒ–APIæœåŠ¡ï¼Œé€šè¿‡HTTP APIæ¥å£å®ç°è§†é¢‘ç¼–è¾‘çš„è‡ªåŠ¨åŒ–æ“ä½œã€‚é¡¹ç›®æ”¯æŒè§†é¢‘ç”Ÿæˆã€è‰ç¨¿ç®¡ç†ã€OSSäº‘å­˜å‚¨ç­‰åŠŸèƒ½ã€‚

### ğŸŒ å½“å‰éƒ¨ç½²çŠ¶æ€
- **âœ… æœåŠ¡çŠ¶æ€**: æ­£åœ¨è¿è¡Œ
- **ğŸŒ è®¿é—®åœ°å€**: http://8.148.70.18:9000
- **ğŸ Pythonç‰ˆæœ¬**: 3.9.7
- **ğŸ“ éƒ¨ç½²ä½ç½®**: /home/CapCutAPI

## ğŸ¬ æ ¸å¿ƒåŠŸèƒ½ç½‘ç»œåˆ†æ

### 1. è§†é¢‘ç”ŸæˆåŠŸèƒ½

#### 1.1 è§†é¢‘ç´ æä¸‹è½½
**ç½‘ç»œä½¿ç”¨æƒ…å†µ:**
- **åè®®**: HTTP/HTTPS
- **å·¥å…·**: ffmpeg (å‘½ä»¤è¡Œä¸‹è½½)
- **é‡è¯•æœºåˆ¶**: 3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ç­–ç•¥
- **è¶…æ—¶è®¾ç½®**: 180ç§’
- **è¿›åº¦ç›‘æ§**: å®æ—¶ä¸‹è½½è¿›åº¦æ˜¾ç¤º

**ä»£ç ä½ç½®**: `downloader.py`
```python
def download_video(video_url, draft_name, material_name):
    # ä½¿ç”¨ffmpegä¸‹è½½è§†é¢‘
    command = [
        'ffmpeg',
        '-i', video_url,
        '-c', 'copy',  # ç›´æ¥å¤åˆ¶ï¼Œä¸é‡æ–°ç¼–ç 
        local_path
    ]
```

#### 1.2 å›¾ç‰‡ç´ æä¸‹è½½
**ç½‘ç»œä½¿ç”¨æƒ…å†µ:**
- **æ ¼å¼è½¬æ¢**: ç»Ÿä¸€è½¬æ¢ä¸ºPNGæ ¼å¼
- **é€æ˜åº¦æ”¯æŒ**: RGBAæ ¼å¼
- **å•å¸§å¤„ç†**: ç¡®ä¿åªå¤„ç†ä¸€å¸§

**ä»£ç ä½ç½®**: `downloader.py`
```python
def download_image(image_url, draft_name, material_name):
    command = [
        'ffmpeg',
        '-i', image_url,
        '-vf', 'format=rgba',  # è½¬æ¢ä¸ºRGBAæ ¼å¼æ”¯æŒé€æ˜åº¦
        '-frames:v', '1',      # ç¡®ä¿åªå¤„ç†ä¸€å¸§
        '-y',                  # è¦†ç›–ç°æœ‰æ–‡ä»¶
        local_path
    ]
```

#### 1.3 éŸ³é¢‘ç´ æä¸‹è½½
**ç½‘ç»œä½¿ç”¨æƒ…å†µ:**
- **æ ¼å¼è½¬æ¢**: ç»Ÿä¸€è½¬æ¢ä¸ºMP3æ ¼å¼
- **è´¨é‡è®¾ç½®**: ä½¿ç”¨libmp3lameç¼–ç å™¨
- **è´¨é‡æ§åˆ¶**: q:a=2 (å¹³è¡¡è´¨é‡å’Œæ–‡ä»¶å¤§å°)

**ä»£ç ä½ç½®**: `downloader.py`
```python
def download_audio(audio_url, draft_name, material_name):
    command = [
        'ffmpeg',
        '-i', audio_url,          # è¾“å…¥URL
        '-c:a', 'libmp3lame',     # å¼ºåˆ¶ç¼–ç ä¸ºMP3
        '-q:a', '2',              # éŸ³é¢‘è´¨é‡è®¾ç½®
        '-y',                     # è¦†ç›–ç°æœ‰æ–‡ä»¶
        local_path                # è¾“å‡ºè·¯å¾„
    ]
```

### 2. è‰ç¨¿ç®¡ç†åŠŸèƒ½

#### 2.1 è‰ç¨¿åˆ›å»º
**ç½‘ç»œä½¿ç”¨æƒ…å†µ:**
- **APIæ¥å£**: POST /create_draft
- **è¿”å›æ•°æ®**: åŒ…å«draft_idå’Œdraft_url
- **æ¨¡æ¿æ”¯æŒ**: æ”¯æŒå‰ªæ˜ å’ŒCapCutå›½é™…ç‰ˆæ¨¡æ¿

**ä»£ç ä½ç½®**: `capcut_server.py`
```python
@app.route('/create_draft', methods=['POST'])
def create_draft_service():
    data = request.get_json()
    draft_name = data.get('draft_name', 'default_draft')
    width = data.get('width', 1080)
    height = data.get('height', 1920)
```

#### 2.2 è‰ç¨¿ä¿å­˜
**ç½‘ç»œä½¿ç”¨æƒ…å†µ:**
- **æœ¬åœ°ä¿å­˜**: ç”Ÿæˆdfd_å¼€å¤´çš„æ–‡ä»¶å¤¹
- **OSSä¸Šä¼ **: è‡ªåŠ¨ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS
- **URLç”Ÿæˆ**: ç”Ÿæˆå¯è®¿é—®çš„draft_url

**ä»£ç ä½ç½®**: `save_draft_impl.py`
```python
def save_draft_impl(draft_id: str, draft_folder: str = None):
    # ä¿å­˜è‰ç¨¿åˆ°æœ¬åœ°
    draft_folder_for_duplicate = draft.Draft_folder("./")
    template_dir = "template" if IS_CAPCUT_ENV else "template_jianying"
    draft_folder_for_duplicate.duplicate_as_template(template_dir, draft_id)
```

### 3. OSSäº‘å­˜å‚¨åŠŸèƒ½

#### 3.1 OSSé…ç½®
**ç½‘ç»œé…ç½®:**
- **æœåŠ¡å•†**: é˜¿é‡Œäº‘OSS
- **åœ°åŸŸ**: æ­¦æ±‰ (oss-cn-wuhan-lr.aliyuncs.com)
- **å­˜å‚¨æ¡¶**: zdaigfpt
- **åŸŸå**: https://zdaigfpt.oss-cn-wuhan-lr.aliyuncs.com

**é…ç½®æ–‡ä»¶**: `config.json`
```json
{
  "is_capcut_env": false,
  "draft_domain": "https://zdaigfpt.oss-cn-wuhan-lr.aliyuncs.com",
  "preview_router": "/draft/downloader",
  "is_upload_draft": true,
  "oss_config": {
    "bucket_name": "zdaigfpt",
    "access_key_id": "LTAI5tLhTQGk2Di25ArrkgGG",
    "access_key_secret": "FfUsEHDArxdhVDYOoBTq46vbjdx5Ae",
    "endpoint": "oss-cn-wuhan-lr.aliyuncs.com"
  }
}
```

#### 3.2 OSSä¸Šä¼ åŠŸèƒ½
**ç½‘ç»œä½¿ç”¨æƒ…å†µ:**
- **SDK**: oss2 (é˜¿é‡Œäº‘OSS Python SDK)
- **è®¤è¯æ–¹å¼**: AccessKeyè®¤è¯
- **URLæœ‰æ•ˆæœŸ**: 24å°æ—¶
- **æ–‡ä»¶æ¸…ç†**: ä¸Šä¼ åè‡ªåŠ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶

**ä»£ç ä½ç½®**: `oss.py`
```python
def upload_to_oss(path):
    # åˆ›å»ºOSSå®¢æˆ·ç«¯
    auth = oss2.Auth(OSS_CONFIG['access_key_id'], OSS_CONFIG['access_key_secret'])
    bucket = oss2.Bucket(auth, OSS_CONFIG['endpoint'], OSS_CONFIG['bucket_name'])
    
    # ä¸Šä¼ æ–‡ä»¶
    object_name = os.path.basename(path)
    bucket.put_object_from_file(object_name, path)
    
    # ç”Ÿæˆç­¾åURL (24å°æ—¶æœ‰æ•ˆ)
    url = bucket.sign_url('GET', object_name, 24 * 60 * 60)
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    os.remove(path)
    
    return url
```

#### 3.3 MP4ä¸“ç”¨ä¸Šä¼ 
**ç½‘ç»œä½¿ç”¨æƒ…å†µ:**
- **ç­¾åæ–¹å¼**: v4ç­¾å
- **è‡ªå®šä¹‰åŸŸå**: æ”¯æŒCNAMEåŸŸå
- **è·¯å¾„å®‰å…¨**: slash_safe=Trueé¿å…è·¯å¾„è½¬ä¹‰

**ä»£ç ä½ç½®**: `oss.py`
```python
def upload_mp4_to_oss(path):
    # ä½¿ç”¨v4ç­¾å
    auth = oss2.AuthV4(MP4_OSS_CONFIG['access_key_id'], MP4_OSS_CONFIG['access_key_secret'])
    
    # åˆ›å»ºOSSå®¢æˆ·ç«¯
    bucket = oss2.Bucket(
        auth, 
        MP4_OSS_CONFIG['endpoint'], 
        MP4_OSS_CONFIG['bucket_name'], 
        region=MP4_OSS_CONFIG['region'], 
        is_cname=True
    )
    
    # ç”Ÿæˆé¢„ç­¾åURL
    url = bucket.sign_url('GET', object_name, 24 * 60 * 60, slash_safe=True)
```

### 4. APIæ¥å£ç½‘ç»œåˆ†æ

#### 4.1 ä¸»è¦APIç«¯ç‚¹
| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | ç½‘ç»œä½¿ç”¨ |
|------|------|------|----------|
| `/create_draft` | POST | åˆ›å»ºè‰ç¨¿ | æœ¬åœ°æ–‡ä»¶æ“ä½œ |
| `/add_video` | POST | æ·»åŠ è§†é¢‘ | HTTPä¸‹è½½è§†é¢‘æ–‡ä»¶ |
| `/add_audio` | POST | æ·»åŠ éŸ³é¢‘ | HTTPä¸‹è½½éŸ³é¢‘æ–‡ä»¶ |
| `/add_image` | POST | æ·»åŠ å›¾ç‰‡ | HTTPä¸‹è½½å›¾ç‰‡æ–‡ä»¶ |
| `/add_text` | POST | æ·»åŠ æ–‡æœ¬ | æœ¬åœ°æ–‡æœ¬å¤„ç† |
| `/add_subtitle` | POST | æ·»åŠ å­—å¹• | æœ¬åœ°å­—å¹•å¤„ç† |
| `/add_effect` | POST | æ·»åŠ ç‰¹æ•ˆ | æœ¬åœ°ç‰¹æ•ˆå¤„ç† |
| `/add_sticker` | POST | æ·»åŠ è´´çº¸ | HTTPä¸‹è½½è´´çº¸æ–‡ä»¶ |
| `/save_draft` | POST | ä¿å­˜è‰ç¨¿ | OSSä¸Šä¼ è‰ç¨¿æ–‡ä»¶ |

#### 4.2 ç½‘ç»œè¯·æ±‚ç¤ºä¾‹
**åˆ›å»ºè‰ç¨¿:**
```bash
curl -X POST http://8.148.70.18:9000/create_draft \
  -H "Content-Type: application/json" \
  -d '{
    "draft_name": "æˆ‘çš„è§†é¢‘é¡¹ç›®",
    "width": 1080,
    "height": 1920
  }'
```

**æ·»åŠ è§†é¢‘:**
```bash
curl -X POST http://8.148.70.18:9000/add_video \
  -H "Content-Type: application/json" \
  -d '{
    "draft_id": "your_draft_id",
    "video_url": "https://example.com/video.mp4",
    "start": 0,
    "end": 10,
    "width": 1080,
    "height": 1920
  }'
```

**ä¿å­˜è‰ç¨¿:**
```bash
curl -X POST http://8.148.70.18:9000/save_draft \
  -H "Content-Type: application/json" \
  -d '{
    "draft_id": "your_draft_id"
  }'
```

### 5. ç½‘ç»œä¼˜åŒ–å’Œå®‰å…¨

#### 5.1 ä¸‹è½½ä¼˜åŒ–
- **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒä¸‹è½½ä¸­æ–­åé‡è¯•
- **è¿›åº¦ç›‘æ§**: å®æ—¶æ˜¾ç¤ºä¸‹è½½è¿›åº¦
- **æ–‡ä»¶ç¼“å­˜**: é¿å…é‡å¤ä¸‹è½½ç›¸åŒæ–‡ä»¶
- **æ ¼å¼è½¬æ¢**: ç»Ÿä¸€æ–‡ä»¶æ ¼å¼ï¼Œæé«˜å…¼å®¹æ€§

#### 5.2 å®‰å…¨æªæ–½
- **HTTPS**: æ‰€æœ‰å¤–éƒ¨ç½‘ç»œè¯·æ±‚ä½¿ç”¨HTTPS
- **è¶…æ—¶æ§åˆ¶**: è®¾ç½®åˆç†çš„ç½‘ç»œè¶…æ—¶æ—¶é—´
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **èµ„æºæ¸…ç†**: åŠæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶

#### 5.3 æ€§èƒ½ä¼˜åŒ–
- **å¹¶å‘ä¸‹è½½**: æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘ä¸‹è½½
- **æ–‡ä»¶å‹ç¼©**: è‰ç¨¿æ–‡ä»¶å‹ç¼©åä¸Šä¼ 
- **ç¼“å­˜æœºåˆ¶**: æœ¬åœ°ç¼“å­˜å‡å°‘é‡å¤ä¸‹è½½
- **å¼‚æ­¥å¤„ç†**: åå°å¼‚æ­¥å¤„ç†å¤§æ–‡ä»¶

## ğŸ“Š ç½‘ç»œä½¿ç”¨ç»Ÿè®¡

### å½“å‰é…ç½®çš„ç½‘ç»œæœåŠ¡
1. **é˜¿é‡Œäº‘OSS**: ç”¨äºè‰ç¨¿æ–‡ä»¶å­˜å‚¨å’Œåˆ†äº«
2. **HTTP/HTTPS**: ç”¨äºç´ ææ–‡ä»¶ä¸‹è½½
3. **ffmpeg**: ç”¨äºè§†é¢‘/éŸ³é¢‘/å›¾ç‰‡å¤„ç†
4. **Flask API**: æä¾›HTTP APIæœåŠ¡

### ç½‘ç»œæµé‡åˆ†æ
- **ä¸Šä¼ æµé‡**: ä¸»è¦æ¥è‡ªè‰ç¨¿æ–‡ä»¶ä¸Šä¼ åˆ°OSS
- **ä¸‹è½½æµé‡**: ä¸»è¦æ¥è‡ªç´ ææ–‡ä»¶ä¸‹è½½
- **APIæµé‡**: æ¥è‡ªå®¢æˆ·ç«¯APIè°ƒç”¨

## ğŸ”§ ç½‘ç»œé…ç½®å»ºè®®

### 1. ç½‘ç»œç¯å¢ƒè¦æ±‚
- **å¸¦å®½**: å»ºè®®è‡³å°‘10Mbpsä¸Šä¼ å¸¦å®½
- **ç¨³å®šæ€§**: éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥
- **é˜²ç«å¢™**: ç¡®ä¿9000ç«¯å£å¼€æ”¾

### 2. ç›‘æ§å»ºè®®
- **ç½‘ç»œç›‘æ§**: ç›‘æ§ç½‘ç»œè¿æ¥çŠ¶æ€
- **æµé‡ç›‘æ§**: ç›‘æ§ä¸Šä¼ ä¸‹è½½æµé‡
- **é”™è¯¯ç›‘æ§**: ç›‘æ§ç½‘ç»œé”™è¯¯å’Œé‡è¯•æ¬¡æ•°

### 3. ä¼˜åŒ–å»ºè®®
- **CDNåŠ é€Ÿ**: è€ƒè™‘ä½¿ç”¨CDNåŠ é€Ÿç´ æä¸‹è½½
- **è´Ÿè½½å‡è¡¡**: è€ƒè™‘å¤šæœåŠ¡å™¨è´Ÿè½½å‡è¡¡
- **ç¼“å­˜ç­–ç•¥**: ä¼˜åŒ–æœ¬åœ°ç¼“å­˜ç­–ç•¥

## ğŸ“ æ€»ç»“

CapCutAPIé¡¹ç›®åœ¨ç½‘ç»œä½¿ç”¨æ–¹é¢å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **å¤šåè®®æ”¯æŒ**: æ”¯æŒHTTP/HTTPSã€OSSç­‰å¤šç§ç½‘ç»œåè®®
2. **æ™ºèƒ½ä¸‹è½½**: ä½¿ç”¨ffmpegè¿›è¡Œæ™ºèƒ½æ–‡ä»¶ä¸‹è½½å’Œæ ¼å¼è½¬æ¢
3. **äº‘å­˜å‚¨é›†æˆ**: æ·±åº¦é›†æˆé˜¿é‡Œäº‘OSSï¼Œæ”¯æŒè‰ç¨¿æ–‡ä»¶äº‘ç«¯å­˜å‚¨
4. **APIæœåŠ¡**: æä¾›å®Œæ•´çš„HTTP APIæœåŠ¡ï¼Œæ”¯æŒè¿œç¨‹è°ƒç”¨
5. **é”™è¯¯å¤„ç†**: å®Œå–„çš„ç½‘ç»œé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

é¡¹ç›®é€šè¿‡åˆç†çš„ç½‘ç»œæ¶æ„è®¾è®¡ï¼Œå®ç°äº†è§†é¢‘ç”Ÿæˆã€è‰ç¨¿ç®¡ç†ã€OSSä¸Šä¼ ç­‰åŠŸèƒ½çš„å®Œæ•´å·¥ä½œæµç¨‹ï¼Œä¸ºç”¨æˆ·æä¾›äº†ç¨³å®šå¯é çš„è§†é¢‘ç¼–è¾‘è‡ªåŠ¨åŒ–æœåŠ¡ã€‚