# CapCutAPI 项目网络分析报告

## 📋 项目概述

CapCutAPI是一个基于Python Flask的剪映/CapCut自动化API服务，通过HTTP API接口实现视频编辑的自动化操作。项目支持视频生成、草稿管理、OSS云存储等功能。

### 🌐 当前部署状态
- **✅ 服务状态**: 正在运行
- **🌍 访问地址**: http://8.148.70.18:9000
- **🐍 Python版本**: 3.9.7
- **📍 部署位置**: /home/CapCutAPI

## 🎬 核心功能网络分析

### 1. 视频生成功能

#### 1.1 视频素材下载
**网络使用情况:**
- **协议**: HTTP/HTTPS
- **工具**: ffmpeg (命令行下载)
- **重试机制**: 3次重试，指数退避策略
- **超时设置**: 180秒
- **进度监控**: 实时下载进度显示

**代码位置**: `downloader.py`
```python
def download_video(video_url, draft_name, material_name):
    # 使用ffmpeg下载视频
    command = [
        'ffmpeg',
        '-i', video_url,
        '-c', 'copy',  # 直接复制，不重新编码
        local_path
    ]
```

#### 1.2 图片素材下载
**网络使用情况:**
- **格式转换**: 统一转换为PNG格式
- **透明度支持**: RGBA格式
- **单帧处理**: 确保只处理一帧

**代码位置**: `downloader.py`
```python
def download_image(image_url, draft_name, material_name):
    command = [
        'ffmpeg',
        '-i', image_url,
        '-vf', 'format=rgba',  # 转换为RGBA格式支持透明度
        '-frames:v', '1',      # 确保只处理一帧
        '-y',                  # 覆盖现有文件
        local_path
    ]
```

#### 1.3 音频素材下载
**网络使用情况:**
- **格式转换**: 统一转换为MP3格式
- **质量设置**: 使用libmp3lame编码器
- **质量控制**: q:a=2 (平衡质量和文件大小)

**代码位置**: `downloader.py`
```python
def download_audio(audio_url, draft_name, material_name):
    command = [
        'ffmpeg',
        '-i', audio_url,          # 输入URL
        '-c:a', 'libmp3lame',     # 强制编码为MP3
        '-q:a', '2',              # 音频质量设置
        '-y',                     # 覆盖现有文件
        local_path                # 输出路径
    ]
```

### 2. 草稿管理功能

#### 2.1 草稿创建
**网络使用情况:**
- **API接口**: POST /create_draft
- **返回数据**: 包含draft_id和draft_url
- **模板支持**: 支持剪映和CapCut国际版模板

**代码位置**: `capcut_server.py`
```python
@app.route('/create_draft', methods=['POST'])
def create_draft_service():
    data = request.get_json()
    draft_name = data.get('draft_name', 'default_draft')
    width = data.get('width', 1080)
    height = data.get('height', 1920)
```

#### 2.2 草稿保存
**网络使用情况:**
- **本地保存**: 生成dfd_开头的文件夹
- **OSS上传**: 自动上传到阿里云OSS
- **URL生成**: 生成可访问的draft_url

**代码位置**: `save_draft_impl.py`
```python
def save_draft_impl(draft_id: str, draft_folder: str = None):
    # 保存草稿到本地
    draft_folder_for_duplicate = draft.Draft_folder("./")
    template_dir = "template" if IS_CAPCUT_ENV else "template_jianying"
    draft_folder_for_duplicate.duplicate_as_template(template_dir, draft_id)
```

### 3. OSS云存储功能

#### 3.1 OSS配置
**网络配置:**
- **服务商**: 阿里云OSS
- **地域**: 武汉 (oss-cn-wuhan-lr.aliyuncs.com)
- **存储桶**: zdaigfpt
- **域名**: https://zdaigfpt.oss-cn-wuhan-lr.aliyuncs.com

**配置文件**: `config.json`
```json
{
  "is_capcut_env": false,
  "draft_domain": "https://zdaigfpt.oss-cn-wuhan-lr.aliyuncs.com",
  "preview_router": "/draft/downloader",
  "is_upload_draft": true,
  "oss_config": {
    "bucket_name": "zdaigfpt",
    "access_key_id": "LTAI5tLhTQGk2Di25ArrkgGG",
    "access_key_secret": "FfUsEHDArxdhVDYOoBTq46vbjdx5Ae",
    "endpoint": "oss-cn-wuhan-lr.aliyuncs.com"
  }
}
```

#### 3.2 OSS上传功能
**网络使用情况:**
- **SDK**: oss2 (阿里云OSS Python SDK)
- **认证方式**: AccessKey认证
- **URL有效期**: 24小时
- **文件清理**: 上传后自动删除临时文件

**代码位置**: `oss.py`
```python
def upload_to_oss(path):
    # 创建OSS客户端
    auth = oss2.Auth(OSS_CONFIG['access_key_id'], OSS_CONFIG['access_key_secret'])
    bucket = oss2.Bucket(auth, OSS_CONFIG['endpoint'], OSS_CONFIG['bucket_name'])
    
    # 上传文件
    object_name = os.path.basename(path)
    bucket.put_object_from_file(object_name, path)
    
    # 生成签名URL (24小时有效)
    url = bucket.sign_url('GET', object_name, 24 * 60 * 60)
    
    # 清理临时文件
    os.remove(path)
    
    return url
```

#### 3.3 MP4专用上传
**网络使用情况:**
- **签名方式**: v4签名
- **自定义域名**: 支持CNAME域名
- **路径安全**: slash_safe=True避免路径转义

**代码位置**: `oss.py`
```python
def upload_mp4_to_oss(path):
    # 使用v4签名
    auth = oss2.AuthV4(MP4_OSS_CONFIG['access_key_id'], MP4_OSS_CONFIG['access_key_secret'])
    
    # 创建OSS客户端
    bucket = oss2.Bucket(
        auth, 
        MP4_OSS_CONFIG['endpoint'], 
        MP4_OSS_CONFIG['bucket_name'], 
        region=MP4_OSS_CONFIG['region'], 
        is_cname=True
    )
    
    # 生成预签名URL
    url = bucket.sign_url('GET', object_name, 24 * 60 * 60, slash_safe=True)
```

### 4. API接口网络分析

#### 4.1 主要API端点
| 接口 | 方法 | 功能 | 网络使用 |
|------|------|------|----------|
| `/create_draft` | POST | 创建草稿 | 本地文件操作 |
| `/add_video` | POST | 添加视频 | HTTP下载视频文件 |
| `/add_audio` | POST | 添加音频 | HTTP下载音频文件 |
| `/add_image` | POST | 添加图片 | HTTP下载图片文件 |
| `/add_text` | POST | 添加文本 | 本地文本处理 |
| `/add_subtitle` | POST | 添加字幕 | 本地字幕处理 |
| `/add_effect` | POST | 添加特效 | 本地特效处理 |
| `/add_sticker` | POST | 添加贴纸 | HTTP下载贴纸文件 |
| `/save_draft` | POST | 保存草稿 | OSS上传草稿文件 |

#### 4.2 网络请求示例
**创建草稿:**
```bash
curl -X POST http://8.148.70.18:9000/create_draft \
  -H "Content-Type: application/json" \
  -d '{
    "draft_name": "我的视频项目",
    "width": 1080,
    "height": 1920
  }'
```

**添加视频:**
```bash
curl -X POST http://8.148.70.18:9000/add_video \
  -H "Content-Type: application/json" \
  -d '{
    "draft_id": "your_draft_id",
    "video_url": "https://example.com/video.mp4",
    "start": 0,
    "end": 10,
    "width": 1080,
    "height": 1920
  }'
```

**保存草稿:**
```bash
curl -X POST http://8.148.70.18:9000/save_draft \
  -H "Content-Type: application/json" \
  -d '{
    "draft_id": "your_draft_id"
  }'
```

### 5. 网络优化和安全

#### 5.1 下载优化
- **断点续传**: 支持下载中断后重试
- **进度监控**: 实时显示下载进度
- **文件缓存**: 避免重复下载相同文件
- **格式转换**: 统一文件格式，提高兼容性

#### 5.2 安全措施
- **HTTPS**: 所有外部网络请求使用HTTPS
- **超时控制**: 设置合理的网络超时时间
- **错误处理**: 完善的异常处理机制
- **资源清理**: 及时清理临时文件

#### 5.3 性能优化
- **并发下载**: 支持多线程并发下载
- **文件压缩**: 草稿文件压缩后上传
- **缓存机制**: 本地缓存减少重复下载
- **异步处理**: 后台异步处理大文件

## 📊 网络使用统计

### 当前配置的网络服务
1. **阿里云OSS**: 用于草稿文件存储和分享
2. **HTTP/HTTPS**: 用于素材文件下载
3. **ffmpeg**: 用于视频/音频/图片处理
4. **Flask API**: 提供HTTP API服务

### 网络流量分析
- **上传流量**: 主要来自草稿文件上传到OSS
- **下载流量**: 主要来自素材文件下载
- **API流量**: 来自客户端API调用

## 🔧 网络配置建议

### 1. 网络环境要求
- **带宽**: 建议至少10Mbps上传带宽
- **稳定性**: 需要稳定的网络连接
- **防火墙**: 确保9000端口开放

### 2. 监控建议
- **网络监控**: 监控网络连接状态
- **流量监控**: 监控上传下载流量
- **错误监控**: 监控网络错误和重试次数

### 3. 优化建议
- **CDN加速**: 考虑使用CDN加速素材下载
- **负载均衡**: 考虑多服务器负载均衡
- **缓存策略**: 优化本地缓存策略

## 📝 总结

CapCutAPI项目在网络使用方面具有以下特点：

1. **多协议支持**: 支持HTTP/HTTPS、OSS等多种网络协议
2. **智能下载**: 使用ffmpeg进行智能文件下载和格式转换
3. **云存储集成**: 深度集成阿里云OSS，支持草稿文件云端存储
4. **API服务**: 提供完整的HTTP API服务，支持远程调用
5. **错误处理**: 完善的网络错误处理和重试机制

项目通过合理的网络架构设计，实现了视频生成、草稿管理、OSS上传等功能的完整工作流程，为用户提供了稳定可靠的视频编辑自动化服务。