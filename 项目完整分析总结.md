# CapCutAPI 项目完整分析总结

## 项目概述

CapCutAPI 是一个功能强大的开源 CapCut 处理工具，提供了完整的视频编辑 API 服务。该项目基于 Python 开发，支持跨平台操作，集成了多种 AI 服务和云存储功能。

## 核心功能模块

### 1. 草稿创建模块 (`create_draft.py`)

**功能描述：**
- 创建新的 CapCut 草稿文件
- 管理草稿缓存系统
- 生成唯一的草稿 ID

**核心实现：**
```python
def create_draft(width=1080, height=1920):
    """创建新的 CapCut 草稿"""
    # 生成时间戳和草稿ID
    unix_time = int(time.time())
    unique_id = uuid.uuid4().hex[:8]
    draft_id = f"dfd_cat_{unix_time}_{unique_id}"
    
    # 创建草稿脚本对象
    script = draft.Script_file(width, height)
    
    # 存储到全局缓存
    update_cache(draft_id, script)
    
    return script, draft_id
```

**工作流程：**
1. 生成唯一的草稿 ID（基于时间戳和 UUID）
2. 创建草稿脚本对象，设置视频分辨率
3. 将草稿对象存储到 LRU 缓存中
4. 返回草稿对象和 ID

### 2. 视频轨道添加模块 (`add_video_track.py`)

**功能描述：**
- 向草稿添加视频素材
- 支持视频剪辑、缩放、位置调整
- 支持转场效果和蒙版效果
- 支持播放速度调整

**核心参数：**
- `video_url`: 视频文件 URL
- `start/end`: 视频片段时间范围
- `target_start`: 目标插入位置
- `transform_x/y`: 位置变换
- `scale_x/y`: 缩放比例
- `speed`: 播放速度
- `transition`: 转场效果
- `mask_type`: 蒙版类型

**工作流程：**
1. 获取或创建草稿对象
2. 添加视频轨道（如果不存在）
3. 下载视频文件到本地
4. 创建视频素材对象
5. 设置视频片段参数（时间范围、变换、效果等）
6. 将视频片段添加到轨道

### 3. 音频轨道添加模块 (`add_audio_track.py`)

**功能描述：**
- 向草稿添加音频素材
- 支持音频剪辑、音量调整
- 支持音频特效（变声、场景音效等）
- 支持播放速度调整

**核心参数：**
- `audio_url`: 音频文件 URL
- `start/end`: 音频片段时间范围
- `volume`: 音量级别
- `speed`: 播放速度
- `sound_effects`: 音频特效列表

**工作流程：**
1. 获取或创建草稿对象
2. 添加音频轨道（如果不存在）
3. 下载音频文件到本地
4. 创建音频素材对象
5. 设置音频片段参数
6. 添加音频特效（如果指定）
7. 将音频片段添加到轨道

### 4. 文本添加模块 (`add_text_impl.py`)

**功能描述：**
- 向草稿添加文本内容
- 支持字体、颜色、大小设置
- 支持边框和背景效果
- 支持文本动画效果
- 支持气泡和装饰效果

**核心参数：**
- `text`: 文本内容
- `font`: 字体类型
- `font_color`: 字体颜色
- `font_size`: 字体大小
- `border_*`: 边框相关参数
- `background_*`: 背景相关参数
- `intro/outro_animation`: 入场/出场动画

**工作流程：**
1. 验证字体类型是否支持
2. 获取或创建草稿对象
3. 添加文本轨道
4. 创建文本样式对象
5. 设置边框和背景效果
6. 添加动画效果
7. 将文本片段添加到轨道

### 5. 草稿保存模块 (`save_draft_impl.py`)

**功能描述：**
- 保存草稿文件到本地或云端
- 下载所有媒体文件
- 更新媒体文件元数据
- 压缩草稿文件
- 上传到 OSS 云存储

**核心功能：**

**媒体文件下载：**
```python
def update_media_metadata(script, task_id=None):
    """更新所有媒体文件的元数据"""
    # 处理音频文件
    for audio in script.materials.audios:
        # 获取音频时长
        duration_result = get_video_duration(remote_url)
        audio.duration = int(duration_result["output"] * 1000000)
    
    # 处理视频和图片文件
    for video in script.materials.videos:
        # 获取视频尺寸和时长
        # 使用 ffprobe 获取详细信息
        # 更新视频元数据
```

**草稿保存流程：**
1. 从缓存获取草稿对象
2. 复制模板文件到草稿目录
3. 更新媒体文件元数据
4. 并发下载所有媒体文件
5. 保存草稿信息到 JSON 文件
6. 修复平台信息（Windows/Mac）
7. 压缩草稿文件
8. 上传到 OSS（如果启用）

### 6. 文件下载模块 (`downloader.py`)

**功能描述：**
- 支持视频、音频、图片文件下载
- 智能重试机制
- 进度监控
- 格式转换（音频转 MP3，图片转 PNG）

**核心函数：**
```python
def download_file(url: str, local_filename, max_retries=3, timeout=180):
    """通用文件下载函数"""
    # 支持特殊 HTTP 头（如豆包 OSS）
    # 指数退避重试策略
    # 进度监控
    # 流式下载
```

**下载流程：**
1. 检查文件是否已存在
2. 创建目录结构
3. 设置 HTTP 头（针对特定服务）
4. 流式下载文件
5. 显示下载进度
6. 重试机制（最多 3 次）

## 缓存系统

### 1. 草稿缓存 (`draft_cache.py`)

**功能：**
- LRU 缓存管理草稿对象
- 最大缓存数量限制（10000）
- 自动清理最少使用的草稿

### 2. 任务缓存 (`save_task_cache.py`)

**功能：**
- 管理保存任务状态
- 支持任务进度跟踪
- 最大任务数量限制（1000）

## API 接口

### 主要 API 端点

| 端点 | 方法 | 功能描述 |
|------|------|----------|
| `/create_draft` | POST | 创建新草稿 |
| `/add_video` | POST | 添加视频素材 |
| `/add_audio` | POST | 添加音频素材 |
| `/add_text` | POST | 添加文本内容 |
| `/add_image` | POST | 添加图片素材 |
| `/add_subtitle` | POST | 添加字幕 |
| `/add_effect` | POST | 添加特效 |
| `/add_sticker` | POST | 添加贴纸 |
| `/save_draft` | POST | 保存草稿 |
| `/query_draft_status` | POST | 查询任务状态 |

### 草稿修复 API

| 端点 | 方法 | 功能描述 |
|------|------|----------|
| `/api/download_draft` | POST | 仅下载草稿 |
| `/api/fix_draft` | POST | 仅修复草稿 |
| `/api/download_and_fix_draft` | POST | 下载并修复草稿 |
| `/api/get_fix_methods` | GET | 获取修复方法 |

## 智能修复系统

### 智能修复器 (`smart_draft_fixer.py`)

**功能特点：**
- 只修复需要修复的部分
- 避免不必要的重新创建
- 保留原始文件的完整性
- 修复过程更高效
- 减少处理时间和资源消耗

**修复方法：**
1. **智能修复**（推荐）：只修复需要修复的部分，处理时间最短
2. **直接修改**：在原始文件基础上直接修改，保留文件完整性
3. **传统修复**：完全重建文件结构，适用于严重损坏的草稿
4. **服务器端修复**：直接在服务器上修改文件，无需文件传输

## 配置系统

### 配置文件 (`config.json`)

```json
{
  "is_capcut_env": true,           // 是否为 CapCut 国际版
  "draft_domain": "https://www.install-ai-guider.top",
  "preview_router": "/draft/downloader",
  "is_upload_draft": false,        // 是否上传草稿文件
  "oss_config": {                  // 阿里云 OSS 配置
    "bucket_name": "your-bucket-name",
    "access_key_id": "your-access-key-id",
    "access_key_secret": "your-access-key-secret",
    "endpoint": "https://your-endpoint.aliyuncs.com"
  }
}
```

## 工具函数 (`util.py`)

**核心功能：**
- 颜色转换（十六进制转 RGB）
- 路径检测（Windows/Mac）
- 文件压缩
- URL 哈希生成
- 执行时间监控装饰器

## 工作流程总结

### 创建草稿流程
1. 调用 `/create_draft` API
2. 生成唯一草稿 ID
3. 创建草稿脚本对象
4. 存储到缓存
5. 返回草稿 ID 和 URL

### 添加素材流程
1. 调用相应的添加 API（如 `/add_video`）
2. 获取或创建草稿对象
3. 添加相应的轨道
4. 下载媒体文件
5. 创建素材对象
6. 设置素材参数
7. 添加到轨道
8. 返回更新后的草稿信息

### 保存草稿流程
1. 调用 `/save_draft` API
2. 创建后台任务
3. 复制模板文件
4. 更新媒体文件元数据
5. 并发下载所有媒体文件
6. 保存草稿信息
7. 修复平台信息
8. 压缩草稿文件
9. 上传到 OSS（可选）
10. 返回草稿下载 URL

## 技术特点

### 并发处理
- 使用 ThreadPoolExecutor 进行并发下载
- 最大并发数：16
- 支持任务进度跟踪

### 缓存优化
- LRU 缓存策略
- 自动清理机制
- 内存使用优化

### 错误处理
- 智能重试机制
- 指数退避策略
- 详细的错误日志

### 跨平台支持
- 支持 Windows 和 Mac 路径
- 自动检测平台信息
- 修复平台兼容性问题

## 扩展功能

### AI 集成
- 支持多种 AI 服务
- 智能生成字幕和文本
- 图像处理功能

### 云存储
- 阿里云 OSS 集成
- 支持草稿文件上传
- 支持渲染文件上传

### 网络优化
- 智能下载策略
- 进度监控
- 断点续传支持

## 测试用例

项目提供了丰富的测试用例（`example.py`），包括：

### 视频测试
- `test_video_track01()`: 基本视频轨道添加
- `test_video_track02()`: 循环添加视频轨道
- `test_video_track03()`: 多轨道视频添加
- `test_video_track04()`: 复杂视频场景

### 音频测试
- `test_audio01()`: 基本音频添加
- `test_audio02()`: 多段音频添加
- `test_audio03()`: 循环音频添加
- `test_audio04()`: 多轨道音频

### 文本测试
- `test_text()`: 基本文本添加
- 支持垂直文本、边框、背景等效果

### 图片测试
- `test_image01()`: 基本图片添加
- `test_image02()`: 多图片添加
- `test_image03()`: 多轨道图片
- `test_image04()`: 复杂图片场景

### 特效测试
- `test_effect_01()`: 特效添加
- `test_mask_01()`: 蒙版效果
- `test_mask_02()`: 视频蒙版

### 关键帧测试
- `test_keyframe()`: 基本关键帧
- `test_keyframe_02()`: 批量关键帧

### 贴纸测试
- `test_stiker_01()`: 基本贴纸
- `test_stiker_02()`: 多贴纸
- `test_stiker_03()`: 多轨道贴纸

### 转场测试
- `test_transition_01()`: 图片转场
- `test_transition_02()`: 视频转场

### AI 功能测试
- `test_generate_image01()`: 图像生成
- `test_generate_image02()`: 多图像生成
- `test_speech_01()`: 语音合成

## 项目优势

1. **功能完整**: 支持视频、音频、文本、图片、特效等所有主要功能
2. **性能优化**: 并发下载、智能缓存、LRU 策略
3. **错误处理**: 完善的错误处理和重试机制
4. **跨平台**: 支持 Windows 和 Mac 系统
5. **智能修复**: 多种修复策略，适应不同场景
6. **扩展性强**: 模块化设计，易于扩展
7. **文档完善**: 详细的使用说明和测试用例
8. **开源免费**: 完全开源，可自由使用和修改

## 使用建议

1. **环境配置**: 确保安装了 Python 3.8+ 和 ffmpeg
2. **网络环境**: 确保服务器能够访问外部媒体文件
3. **存储空间**: 预留足够的磁盘空间用于草稿文件
4. **监控日志**: 定期检查服务器日志，及时发现问题
5. **备份策略**: 定期备份重要的草稿文件
6. **性能调优**: 根据实际需求调整并发数和缓存大小

这个项目展现了完整的视频编辑 API 系统架构，具有良好的可扩展性和稳定性，是一个优秀的开源项目。